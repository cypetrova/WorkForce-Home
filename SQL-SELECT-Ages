SELECT
    dom.oblast,
    dom.grs,
    dom.gnezdo,
    dom.domak,
    dom.tm,
    dom.ppg AS year,
    dom.ppm AS month,
    dom.ppd AS day,
    DATEDIFF(
        DAY, 
        CASE 
            WHEN ISDATE(CONCAT(dom.ppg, '-', dom.ppm, '-', dom.ppd)) = 1 
                THEN CONVERT(DATE, CONCAT(dom.ppg, '-', dom.ppm, '-', dom.ppd)) 
            ELSE NULL 
        END, 
        GETDATE()
    ) + 
    CASE 
        WHEN (dom.ppm < MONTH(GETDATE()) OR (dom.ppm = MONTH(GETDATE()) AND dom.ppd <= DAY(GETDATE())))
            THEN 1 
        ELSE 0 
    END AS age_difference
FROM
    dom
JOIN
    lica ON dom.oblast = lica.oblast
        AND dom.grs = lica.grs
        AND dom.gnezdo = lica.gnezdo
        AND dom.domak = lica.domak
        AND dom.tm = lica.tm;
